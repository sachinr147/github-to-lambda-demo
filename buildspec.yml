version: 0.2 # Recommended version for full functionality
env:
  variables:
    # Use variables to define your resource names for easy maintenance.
    S3_BUCKET_NAME: "order-service-build-files-bucket"
    LAMBDA_FUNCTION_NAME: "order-service"
    # This must exactly match the ZIP file name generated by your Maven POM.
    ZIP_FILE_NAME: "aws-lambda-example-1.0-SNAPSHOT.zip"

phases:
  install:
    runtime-versions:
      java: corretto21
    commands:
      - echo "Installing dependencies..."
  pre_build:
    commands:
      - echo Pre-build phase started on `date`
      - echo Current directory contents:
      - ls -la
  build:
    commands:
      - echo "Building and packaging the Lambda function with Maven..."
      # Activates the "assembly-zip" profile defined in your pom.xml.
      - mvn clean install -P assembly-zip
  post_build:
    commands:
      - echo "Navigating to target directory..."
      - cd target
      
      - echo "Uploading the deployment package to S3..."
      # Correct variable syntax: use $VARIABLE_NAME
      - aws s3 cp ${ZIP_FILE_NAME} s3://${S3_BUCKET_NAME}/
      
      - echo "Updating the Lambda function code..."
      # Correct variable syntax: use $VARIABLE_NAME
      - aws lambda update-function-code --function-name ${LAMBDA_FUNCTION_NAME} --s3-bucket ${S3_BUCKET_NAME} --s3-key ${ZIP_FILE_NAME}

artifacts:
  files:
    - target/${ZIP_FILE_NAME}
